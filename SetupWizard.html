<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #667eea;
      --primary-hover: #5a67d8;
      --background-color: #f7fafc;
      --card-background: #ffffff;
      --text-color: #2d3748;
      --subtle-text: #718096;
      --border-color: #e2e8f0;
      --success-color: #38a169;
      --error-color: #e53e3e;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    #wizard {
      background-color: var(--card-background);
      border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }
    .progress-bar {
      width: 100%;
      background-color: var(--border-color);
      height: 8px;
    }
    .progress-bar-inner {
      width: 0%;
      height: 100%;
      background-color: var(--primary-color);
      transition: width 0.5s ease-in-out;
    }
    .step {
      display: none;
      padding: 32px 40px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .step.active {
      display: block;
      opacity: 1;
    }
    h2 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    p { color: var(--subtle-text); line-height: 1.6; margin-bottom: 24px; }
    code { background-color: var(--border-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    .button-group { margin-top: 24px; display: flex; justify-content: flex-end; align-items: center; gap: 12px; }
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
    button:disabled { background-color: #a0aec0; cursor: not-allowed; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-color); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    textarea, input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; margin-top: 8px; box-sizing: border-box; }
    .status-box { padding: 16px; border-radius: 8px; margin-top: 16px; }
    .status-box.success { background-color: #c6f6d5; color: var(--success-color); }
    .status-box.error { background-color: #fed7d7; color: var(--error-color); }
  </style>
</head>
<body>
  <div id="wizard">
    <div class="progress-bar"><div class="progress-bar-inner" id="progressBar"></div></div>

    <!-- –®–∞–≥ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div id="step1" class="step">
      <h2>üöÄ –ú–∞—Å—Ç–µ—Ä –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <p>–≠—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å Telegram-–±–æ—Ç–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
      <div class="button-group">
        <button id="startBtn" onclick="runSetupSheets()">–ù–∞—á–∞—Ç—å</button>
      </div>
    </div>

    <!-- –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–æ–∫–µ–Ω–∞ -->
    <div id="step2" class="step">
      <h2>–®–∞–≥ 1: –¢–æ–∫–µ–Ω Telegram –ë–æ—Ç–∞</h2>
      <p>–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É <code>@BotFather</code> –≤ Telegram, –æ—Ç–ø—Ä–∞–≤–∏–≤ –µ–º—É –∫–æ–º–∞–Ω–¥—É <code>/newbot</code>. <a href="https://telegram.me/botfather" target="_blank">–û—Ç–∫—Ä—ã—Ç—å @BotFather</a></p>
      <textarea id="token" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω —Å—é–¥–∞..."></textarea>
      <div class="button-group">
        <button id="saveTokenBtn" onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>

    <!-- –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ID –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è -->
    <div id="step3" class="step">
      <h2>–®–∞–≥ 2: ID –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è</h2>
      <p>–†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∫–∞–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (<b>–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ &rarr; –ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ</b>) –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ <b>ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è</b> (–Ω–µ URL!).</p>
      <input type="text" id="deploymentId" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è...">
      <div class="button-group">
        <button id="saveDepIdBtn" onclick="saveDeploymentId()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook</button>
      </div>
    </div>

    <!-- –®–∞–≥ 4: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Webhook -->
    <div id="step4" class="step">
      <h2>–®–∞–≥ 3: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Webhook</h2>
      <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ Webhook –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ.</p>
      <div id="webhook-status"></div>
      <div class="button-group">
        <button id="setWebhookBtn" onclick="setWebhook()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="deleteWebhookBtn" onclick="deleteWebhook()">–£–¥–∞–ª–∏—Ç—å</button>
        <button onclick="google.script.host.close()" style="background-color: var(--success-color);">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
    </div>

  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 4;
    let SETTINGS = {}; // –•—Ä–∞–Ω–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ

    function updateProgressBar() {
      const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    function goToStep(stepNumber) {
      currentStep = stepNumber;
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      setTimeout(() => {
        document.getElementById('step' + stepNumber).classList.add('active');
        updateProgressBar();
      }, 50);
    }

    function showLoader(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.disabled = true;
        button.innerHTML = '<div class="spinner"></div>' + button.innerText;
      }
    }

    function hideLoader(buttonId, originalText) {
      const button = document.getElementById(buttonId);
       if (button) {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    function runSetupSheets() {
      showLoader('startBtn');
      google.script.run
        .withSuccessHandler(() => {
            hideLoader('startBtn', '–ù–∞—á–∞—Ç—å');
            goToStep(2);
        })
        .withFailureHandler(err => {
            hideLoader('startBtn', '–ù–∞—á–∞—Ç—å');
            showError(err);
        })
        .setupInitialSheets();
    }

    function saveToken() {
      const token = document.getElementById('token').value;
      if (!token) { alert('–¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
      showLoader('saveTokenBtn');
      google.script.run
        .withSuccessHandler(settings => {
            SETTINGS = settings;
            hideLoader('saveTokenBtn', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å');
            goToStep(3);
        })
        .withFailureHandler(err => { hideLoader('saveTokenBtn', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å'); showError(err); })
        .saveSettings({BOT_TOKEN: token, DEPLOYMENT_ID: SETTINGS.DEPLOYMENT_ID});
    }

    function saveDeploymentId() {
      const deploymentId = document.getElementById('deploymentId').value;
      if (!deploymentId) { alert('ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
      showLoader('saveDepIdBtn');
      google.script.run
        .withSuccessHandler(settings => {
            SETTINGS = settings;
            hideLoader('saveDepIdBtn', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook');
            goToStep(4);
            loadWebhookInfo();
        })
        .withFailureHandler(err => { hideLoader('saveDepIdBtn', '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook'); showError(err); })
        .saveSettings({BOT_TOKEN: SETTINGS.BOT_TOKEN, DEPLOYMENT_ID: deploymentId});
    }

    function loadWebhookInfo() {
      const statusDiv = document.getElementById('webhook-status');
      statusDiv.innerHTML = '<div style="display:flex; align-items:center; gap:8px;"><div class="spinner"></div> <i>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</i></div>';
      google.script.run
        .withSuccessHandler(info => {
          let statusText = '<h4>–°—Ç–∞—Ç—É—Å Webhook</h4>';
          if (info && info.url) {
            statusText += `<p><b>URL –≤ Telegram:</b> ... (—Å–∫—Ä—ã—Ç–æ)</p><p><b>–û–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</b> ${info.pending_update_count}</p>`;
          } else {
            statusText += '<p>Webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</p>';
          }
          statusDiv.innerHTML = statusText;
        })
        .withFailureHandler(err => { statusDiv.innerHTML = `<div class="status-box error">${err.message}</div>`; });
    }

    function setWebhook() {
      showLoader('setWebhookBtn');
      google.script.run
        .withSuccessHandler(() => { hideLoader('setWebhookBtn', '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å'); loadWebhookInfo(); })
        .withFailureHandler(err => { hideLoader('setWebhookBtn', '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å'); showError(err); })
        .setWebhook();
    }

    function deleteWebhook() {
      showLoader('deleteWebhookBtn');
      google.script.run
        .withSuccessHandler(() => { hideLoader('deleteWebhookBtn', '–£–¥–∞–ª–∏—Ç—å'); loadWebhookInfo(); })
        .withFailureHandler(err => { hideLoader('deleteWebhookBtn', '–£–¥–∞–ª–∏—Ç—å'); showError(err); })
        .deleteWebhook();
    }

    function showError(error) {
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    function initializeWizard() {
        google.script.run
            .withSuccessHandler(settings => {
                SETTINGS = settings || {};
                // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
                document.getElementById('token').value = SETTINGS.BOT_TOKEN || '';
                document.getElementById('deploymentId').value = SETTINGS.DEPLOYMENT_ID || '';
                // –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
                goToStep(1);
            })
            .withFailureHandler(showError)
            .getSettings();
    }

    initializeWizard();

  </script>
</body>
</html>