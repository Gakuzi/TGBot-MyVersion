<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    /* –°—Ç–∏–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
    body { font-family: Arial, sans-serif; padding: 20px; }
    .step { display: none; }
    .step.active { display: block; }
    .button-group { margin-top: 20px; }
    textarea { width: 100%; height: 80px; }
  </style>
</head>
<body>
  <div id="wizard">

    <!-- –®–∞–≥ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
    <div id="step1" class="step active">
      <h2>üöÄ –ú–∞—Å—Ç–µ—Ä –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <p>–≠—Ç–æ—Ç –º–∞—Å—Ç–µ—Ä –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å Telegram-–±–æ—Ç–∞ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤.</p>
      <div class="button-group">
        <button onclick="goToStep(2)">–ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
      </div>
    </div>

    <!-- –®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -->
    <div id="step2" class="step">
      <h2>–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¢–∞–±–ª–∏—Ü—ã</h2>
      <p>–ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã.</p>
      <div class="button-group">
        <button onclick="setupSheets()">–°–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç—ã</button>
      </div>
      <p id="step2-status"></p>
    </div>

    <!-- –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–æ–∫–µ–Ω–∞ -->
    <div id="step3" class="step">
      <h2>–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–æ–∫–µ–Ω–∞</h2>
      <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <b>@BotFather</b>.</p>
      <p>2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É <code>/newbot</code> –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º.</p>
      <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ.</p>
      <label for="token">–¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞:</label>
      <textarea id="token"></textarea>
      <div class="button-group">
        <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>

    <!-- –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ID –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è -->
    <div id="step4" class="step">
      <h2>–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook</h2>
      <p>1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞–∂–º–∏—Ç–µ <b>"–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"</b> -> <b>"–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"</b>.</p>
      <p>2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø <b>"–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</b> –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø <b>"–í—Å–µ–º"</b>.</p>
      <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ <b>ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è</b> (–Ω–µ URL!) –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.</p>
      <label for="deploymentId">ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:</label>
      <input type="text" id="deploymentId" style="width: 100%;">
      <div class="button-group">
        <button onclick="saveDeploymentId()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Webhook</button>
      </div>
    </div>

    <!-- –®–∞–≥ 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Webhook -->
    <div id="step5" class="step">
      <h2>–®–∞–≥ 4: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Webhook</h2>
      <div id="webhook-status">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</div>
      <div class="button-group">
        <button onclick="setWebhook()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å Webhook</button>
        <button onclick="deleteWebhook()">–£–¥–∞–ª–∏—Ç—å Webhook</button>
      </div>
      <hr>
      <button onclick="google.script.host.close()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

  </div>

  <script>
    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π ---
    function goToStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById('step' + stepNumber).classList.add('active');
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Google Apps Script ---

    function setupSheets() {
      google.script.run
        .withSuccessHandler(status => {
          document.getElementById('step2-status').innerText = status;
          setTimeout(() => goToStep(3), 2000); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫
        })
        .withFailureHandler(showError)
        .setupInitialSheets();
    }

    function saveToken() {
      const token = document.getElementById('token').value;
      if (!token) { showError('–¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
      google.script.run
        .withSuccessHandler(() => goToStep(4))
        .saveSettings({BOT_TOKEN: token});
    }

    function saveDeploymentId() {
      const deploymentId = document.getElementById('deploymentId').value;
      if (!deploymentId) { showError('ID —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.'); return; }
      google.script.run
        .withSuccessHandler(() => {
          goToStep(5);
          loadWebhookInfo();
        })
        .saveSettings({DEPLOYMENT_ID: deploymentId});
    }

    function loadWebhookInfo() {
      document.getElementById('webhook-status').innerHTML = '<i>–ó–∞–≥—Ä—É–∑–∫–∞...</i>';
      google.script.run
        .withSuccessHandler(info => {
          let statusText = '<h4>–°—Ç–∞—Ç—É—Å Webhook</h4>';
          if (info && info.url) {
            statusText += `<p><b>URL –≤ Telegram:</b> ... (—Å–∫—Ä—ã—Ç–æ –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)</p>`;
            statusText += `<p><b>–û–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</b> ${info.pending_update_count}</p>`;
          } else {
            statusText += '<p>Webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.</p>';
          }
          document.getElementById('webhook-status').innerHTML = statusText;
        })
        .withFailureHandler(showError)
        .getWebhookInfo();
    }

    function setWebhook() {
      google.script.run
        .withSuccessHandler(response => {
          alert('Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω!');
          loadWebhookInfo();
        })
        .withFailureHandler(showError)
        .setWebhook();
    }

    function deleteWebhook() {
      google.script.run
        .withSuccessHandler(response => {
          alert('Webhook —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
          loadWebhookInfo();
        })
        .withFailureHandler(showError)
        .deleteWebhook();
    }

    function showError(error) {
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–∫–Ω–∞, –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ—à–∞–µ–º, –∫–∞–∫–æ–π —à–∞–≥ –ø–æ–∫–∞–∑–∞—Ç—å
    google.script.run.withSuccessHandler(settings => {
      if (!settings.BOT_TOKEN) {
        goToStep(1); // –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
      } else if (!settings.DEPLOYMENT_ID) {
        document.getElementById('token').value = settings.BOT_TOKEN;
        goToStep(3); // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –Ω–æ –Ω–µ—Ç ID, –Ω–∞—á–∏–Ω–∞–µ–º —Å —à–∞–≥–∞ 3
      } else {
        // –ï—Å–ª–∏ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é Webhook
        document.getElementById('token').value = settings.BOT_TOKEN;
        document.getElementById('deploymentId').value = settings.DEPLOYMENT_ID;
        goToStep(5);
        loadWebhookInfo();
      }
    }).getSettings();

  </script>
</body>
</html>
